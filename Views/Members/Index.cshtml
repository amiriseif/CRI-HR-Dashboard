@model HRDashboard.Models.HomeSheetViewModel

@{
    ViewData["Title"] = "Dashboard - Robotique Club ISAMM HR";
}

<style>
    /* Improved table styling */
    .members-table thead th {
        background: linear-gradient(90deg,#0d6efd08,#0d6efd12);
        border-bottom: 2px solid rgba(13,110,253,0.08);
        font-weight:600;
        font-size:0.95rem;
    }
    .members-table tbody td{vertical-align:middle;padding:0.6rem 0.75rem;font-size:0.95rem}
    .members-table tbody tr:hover{background:#fbfdff}
    .chat-container{background:transparent}
</style>

<!-- Welcome Popup (if user just logged in) -->

<!-- Main Dashboard Content -->
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h3>
            <i class="fas fa-chart-line" style="color: #00aaff; margin-right: 10px;"></i>
            @Model.Title
        </h3>
        <p>
            <i class="fas fa-calendar-alt" style="margin-right: 5px;"></i>
            @DateTime.Now.ToString("dddd, MMMM dd, yyyy")
        </p>
    </div>

    <!-- Data Card -->
    <div class="data-card">
        <div style="display:flex;justify-content:flex-end;margin-bottom:8px;">
            <button id="open-chatbot" class="btn btn-primary d-none">Chatbot: query members</button>
        </div>
        @if (Model.Rows == null || Model.Rows.Count == 0)
        {
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                No data found in the Google Sheet.
            </div>
        }
        else
        {
            var headers = Model.Rows[0];
            var dataRows = Model.Rows.Skip(1);
            
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <tr>
                            @foreach (var h in headers)
                            {
                                <th>@h</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in dataRows)
                        {
                            <tr>
                                @foreach (var cell in row)
                                {
                                    <td>@cell</td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<!-- Chatbot Modal -->
<div class="modal fade" id="chatbotModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Members Query Chatbot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="chat-container" style="max-height:50vh;overflow:auto;padding:8px;">
                    <div id="chat-messages" style="display:flex;flex-direction:column;gap:10px;"></div>
                    <div id="chat-results" class="mt-3"></div>
                </div>
                <div class="mt-2">
                    <label for="chat-input" class="form-label">Ask (e.g. unpaid cotisation)</label>
                    <div class="d-flex">
                        <textarea id="chat-input" class="form-control me-2" rows="2"></textarea>
                        <div style="display:flex;flex-direction:column;gap:6px;">
                            <button id="send-chat" class="btn btn-success">Send</button>
                            <button id="reset-filter" class="btn btn-outline-secondary" title="Reset filters">Reset</button>
                        </div>
                    </div>
                    <div class="mt-2"><span id="chat-status"></span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Floating Chatbot Button -->
<button id="chatbot-floating-btn" class="btn btn-primary" style="position:fixed;right:18px;bottom:18px;border-radius:50%;width:56px;height:56px;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,0.15);">
    <i class="fas fa-comments" style="font-size:20px;color:white"></i>
</button>

@section Scripts {
    <script>
        // Auto-hide the welcome popup after 5 seconds with smooth fad

        // Add smooth scroll behavior
        document.addEventListener('DOMContentLoaded', function() {
            document.documentElement.style.scrollBehavior = 'smooth';
        });
        (function(){
            const apiEndpoint = '/Members/QueryAgent';
            const openBtn = document.getElementById('open-chatbot');
            const floatingBtn = document.getElementById('chatbot-floating-btn');
            const sendBtn = document.getElementById('send-chat');
            const inputEl = document.getElementById('chat-input');
            const respEl = document.getElementById('chat-response');
            const statusEl = document.getElementById('chat-status');
            const messagesEl = document.getElementById('chat-messages');

            function showModal() {
                var modal = new bootstrap.Modal(document.getElementById('chatbotModal'));
                modal.show();
                // focus input after modal shown
                setTimeout(() => inputEl.focus(), 250);
            }

            openBtn?.addEventListener('click', showModal);
            floatingBtn?.addEventListener('click', showModal);

            function appendMessage(text, who, meta){
                if(!messagesEl) return;
                const wrapper = document.createElement('div');
                wrapper.className = 'chat-msg ' + (who === 'user' ? 'user' : 'bot');
                wrapper.style.display = 'flex';
                wrapper.style.justifyContent = who === 'user' ? 'flex-end' : 'flex-start';
                const bubble = document.createElement('div');
                bubble.style.maxWidth = '70%';
                bubble.style.padding = '10px 12px';
                bubble.style.borderRadius = '14px';
                bubble.style.background = who === 'user' ? '#0d6efd' : '#f1f3f5';
                bubble.style.color = who === 'user' ? 'white' : 'black';
                bubble.style.boxShadow = '0 2px 6px rgba(0,0,0,0.08)';
                bubble.textContent = text;
                wrapper.appendChild(bubble);
                messagesEl.appendChild(wrapper);
                // scroll to bottom
                const container = messagesEl.parentElement;
                if(container) container.scrollTop = container.scrollHeight;
            }

            sendBtn?.addEventListener('click', async function(){
                const value = inputEl.value?.trim();
                if(!value){
                    statusEl.textContent = 'Please enter a question.';
                    return;
                }
                statusEl.textContent = '';
                appendMessage(value, 'user');
                inputEl.value = '';
                // show bot pending
                const pendingId = 'pending-' + Date.now();
                appendMessage('...', 'bot');
                try{
                    const res = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userInput: value })
                    });
                    if(!res.ok){
                        const text = await res.text();
                        appendMessage('Error: ' + res.status + '\n' + text, 'bot');
                        statusEl.textContent = 'Error';
                        return;
                    }
                    const json = await res.json();
                    // replace last bot '...' with success message and a Show Query button
                    const botMessages = Array.from(messagesEl.querySelectorAll('.chat-msg.bot'));
                    if(botMessages.length) botMessages[botMessages.length-1].remove();
                    // show friendly success message
                    appendMessage('Query generated successfully.', 'bot');
                    // add a small action button to reveal the query
                    const actionWrapper = document.createElement('div');
                    actionWrapper.style.display = 'flex';
                    actionWrapper.style.justifyContent = 'flex-start';
                    const showBtn = document.createElement('button');
                    showBtn.className = 'btn btn-sm btn-outline-primary';
                    showBtn.textContent = 'Show query';
                    const queryPre = document.createElement('pre');
                    queryPre.style.display = 'none';
                    queryPre.style.background = '#f8f9fa';
                    queryPre.style.padding = '10px';
                    queryPre.style.borderRadius = '6px';
                    queryPre.style.marginTop = '8px';
                    const raw = json.raw || json.linqQuery || JSON.stringify(json, null, 2);
                    queryPre.textContent = raw;
                    showBtn.addEventListener('click', function(){
                        if(queryPre.style.display === 'none') {
                            queryPre.style.display = 'block';
                            showBtn.textContent = 'Hide query';
                        } else {
                            queryPre.style.display = 'none';
                            showBtn.textContent = 'Show query';
                        }
                    });
                    actionWrapper.appendChild(showBtn);
                    messagesEl.appendChild(actionWrapper);
                    messagesEl.appendChild(queryPre);
                    // render results inside the chat modal (do not change main table)
                    const resultsEl = document.getElementById('chat-results');
                    if (resultsEl) {
                        resultsEl.innerHTML = ''; // clear previous
                        if (json.members && Array.isArray(json.members) && json.members.length > 0) {
                            const tbl = document.createElement('table');
                            tbl.className = 'table table-sm members-table';
                            const thead = document.createElement('thead');
                            const headerRow = document.createElement('tr');
                            const headers = ['ExternalId','Email','Name','Phone','Address','Type','MembershipStatus','Department','CotisationPaymentStatus'];
                            headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; headerRow.appendChild(th); });
                            thead.appendChild(headerRow);
                            tbl.appendChild(thead);
                            const tb = document.createElement('tbody');
                            json.members.forEach(m => {
                                const tr = document.createElement('tr');
                                const cells = [m.externalId, m.email || '', m.name || '', m.phoneNumber || '', m.adresse || '', m.typeMembership || '', m.membershipStatus || '', m.department || '', m.cotisationPaymentStatus || ''];
                                cells.forEach(c => { const td = document.createElement('td'); td.textContent = c; tr.appendChild(td); });
                                tb.appendChild(tr);
                            });
                            tbl.appendChild(tb);
                            resultsEl.appendChild(tbl);
                        } else {
                            const p = document.createElement('div');
                            p.className = 'text-muted small';
                            p.textContent = 'No matching members.';
                            resultsEl.appendChild(p);
                        }
                        // scroll results into view
                        resultsEl.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }
                    statusEl.textContent = 'Done';
                }catch(err){
                    appendMessage('Request failed: ' + (err && err.message ? err.message : String(err)), 'bot');
                    statusEl.textContent = 'Request failed';
                }
            });

            // Reset: clear chat messages and results (do not touch main table)
            const resetBtn = document.getElementById('reset-filter');
            resetBtn?.addEventListener('click', function(){
                if(messagesEl) messagesEl.innerHTML = '';
                const resultsEl = document.getElementById('chat-results');
                if(resultsEl) resultsEl.innerHTML = '';
                statusEl.textContent = '';
            });
        })();
    </script>
}